# Video2Markdown V2 处理流程（重新设计）

## 核心设计理念

**Text-First & AI-Centric**: 让 AI 直接处理转录文本，去除冗余，生成高质量结构化文档。图片仅作辅助，不强制 AI 分析。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         简化后的处理流程 (V2)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   输入视频                                                                   │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 1: 视频分析 (保持不变)                                        │  │
│   │ • 读取视频元数据 (FFmpeg)                                           │  │
│   │ • 计算关键帧采样间隔                                                │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 2: 音频提取与转录                                             │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   ┌─────────────┐    ┌─────────────┐                               │  │
│   │   │  提取音频   │───▶│  Whisper    │                               │  │
│   │   │  (WAV)     │    │   转录      │                               │  │
│   │   │             │    │             │                               │  │
│   │   │ • FFmpeg   │    │ • 本地模型  │                               │  │
│   │   │ • 16kHz    │    │ • 原语言    │                               │  │
│   │   │ • 单声道   │    │ • 带时间戳  │                               │  │
│   │   └─────────────┘    └─────────────┘                               │  │
│   │                                                                     │  │
│   │   输出: TranscriptSegment[]                                        │  │
│   │     - start_time: float                                             │  │
│   │     - end_time: float                                               │  │
│   │     - text: str (原语言，如繁体中文)                                │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 3: AI 文档生成 (核心改进)                                     │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   输入: 转录文本 (原语言) + 视频时长信息                            │  │
│   │                                                                     │  │
│   │   AI 处理流程 (单步完成):                                           │  │
│   │                                                                     │  │
│   │   ┌─────────────────────────────────────────────────────────────┐  │  │
│   │   │  Kimi API 调用                                               │  │  │
│   │   │                                                              │  │  │
│   │   │  系统指令:                                                   │  │  │
│   │   │  "你是一个专业的视频内容编辑助手。请对提供的视频转录文字    │  │  │
│   │   │   进行以下处理：                                             │  │  │
│   │   │                                                              │  │  │
│   │   │   1. 去重优化：                                              │  │  │
│   │   │      - 识别并合并重复的表述                                  │  │  │
│   │   │      - 去除口语化的冗余（嗯、啊、那个等）                    │  │  │
│   │   │      - 修正语音识别错误（根据上下文推断）                    │  │  │
│   │   │                                                              │  │  │
│   │   │   2. 结构化处理：                                            │  │  │
│   │   │      - 将内容划分为 3-6 个逻辑章节                           │  │  │
│   │   │      - 每个章节给出：标题、时间范围、内容摘要                │  │  │
│   │   │      - 识别关键要点，用 bullet points 呈现                   │  │  │
│   │   │                                                              │  │  │
│   │   │   3. 语言转换：                                              │  │  │
│   │   │      - 将所有内容转换为简体中文                              │  │  │
│   │   │      - 保持技术术语的准确性                                  │  │  │
│   │   │                                                              │  │  │
│   │   │   4. 格式规范：                                              │  │  │
│   │   │      - 使用 Markdown 格式                                    │  │  │
│   │   │      - 添加目录导航                                          │  │  │
│   │   │      - 保留时间戳引用"                                       │  │  │
│   │   │                                                              │  │  │
│   │   │  输入: 转录文本 + 时间戳映射                                 │  │  │
│   │   │  输出: 结构化的 Markdown 文档                                │  │  │
│   │   └─────────────────────────────────────────────────────────────┘  │  │
│   │                                                                     │  │
│   │   单次 API 调用完成所有处理！                                      │  │
│   │   预计耗时: 10-20 秒 (取决于视频长度)                              │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 4: 关键帧提取 (可选/并行)                                     │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   目的: 为文档配图，提供视觉参考                                    │  │
│   │                                                                     │  │
│   │   简化策略:                                                         │  │
│   │   • 仅提取关键帧，不强制 AI 分析                                    │  │
│   │   • 根据章节时间戳匹配对应图片                                      │  │
│   │   • 图片仅作展示，不生成描述                                        │  │
│   │                                                                     │  │
│   │   输出: 按时间排序的关键帧图片                                      │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 5: Markdown 组装                                              │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   组合内容:                                                         │  │
│   │   • AI 生成的结构化文档 (主体)                                      │  │
│   │   • 章节相关关键帧图片 (辅助)                                       │  │
│   │   • 原始转录文字 (折叠显示，可选)                                   │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   输出文件                                                                   │
│   ┌─────────────────────────────────────────────────────────────────┐     │
│   │  • {title}.md          - 主文档 (AI 生成的高质量简体中文)        │     │
│   │  • {title}.srt         - 字幕文件 (原语言，供参考)              │     │
│   │  • {title}_frames/     - 关键帧图片 (自动配图)                  │     │
│   └─────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## V2 改进点

### 1. 简化流程

| 版本 | 阶段数 | API 调用次数 | 处理时间 |
|-----|-------|-------------|---------|
| V1 | 7 阶段 | N 次图片 + 1 次文档 | 6-8 分钟 |
| **V2** | **5 阶段** | **1 次** | **2-3 分钟** |

### 2. AI Prompt 设计

```python
DOCUMENT_GENERATION_PROMPT = """
你是一个专业的视频内容编辑助手。请对提供的视频转录文字进行处理，生成高质量的结构化文档。

## 处理要求

### 1. 内容优化
- 去除口语化冗余（"嗯"、"啊"、"那个"等填充词）
- 合并重复表述，保留最清晰的版本
- 修正明显的语音识别错误（根据上下文推断）
- 保持技术术语和专业名词的准确性

### 2. 结构化处理
- 将内容划分为 3-6 个逻辑章节
- 每个章节包含：
  * 标题（概括该章核心内容）
  * 时间范围（从原文时间戳提取）
  * 内容摘要（200-400 字的段落总结）
  * 关键要点（3-5 个 bullet points）

### 3. 语言转换
- 将所有内容转换为简体中文
- 如果是繁体中文输入，请转换为简体
- 保持人名、地名、技术术语的准确性

### 4. 输出格式
使用以下 Markdown 模板：

```markdown
# {视频标题}

## 目录
1. [章节1标题](#section-1)
2. [章节2标题](#section-2)
...

---

## 1. 章节标题

**时间范围:** [00:00:00 - 00:05:00]

### 内容摘要
{AI 生成的段落总结}

### 关键要点
- 要点 1
- 要点 2
- 要点 3

---

## 2. 章节标题
...
```

### 5. 输入数据
转录文本格式（JSON）：
```json
{
  "title": "视频标题",
  "duration": 600,
  "segments": [
    {"start": 0.0, "end": 5.2, "text": "转录文本1"},
    {"start": 5.2, "end": 12.8, "text": "转录文本2"}
  ]
}
```

请直接输出 Markdown 格式的完整文档。
"""
```

### 3. 成本对比

| 项目 | V1 (原方案) | V2 (新方案) |
|-----|------------|------------|
| 图片分析 API | 8-15 次 × ¥0.015 = ¥0.12-0.22 | 0 次 = ¥0 |
| 文档生成 API | 1 次 × ¥0.006 = ¥0.006 | 1 次 × ¥0.012 = ¥0.012 |
| **单视频成本** | **¥0.13-0.23** | **¥0.012** |
| 成本降低 | - | **90-95%** |

### 4. 质量对比

| 维度 | V1 | V2 |
|-----|----|----|
| 内容准确性 | 依赖图片分析准确性 | 直接基于文本，更准确 |
| 信息完整性 | 可能遗漏无图片章节 | 完整覆盖所有内容 |
| 阅读体验 | 图文并茂 | 简洁高效 |
| 处理速度 | 6-8 分钟 | 2-3 分钟 |

## 实现计划

### Phase 1: 核心流程重构
1. 移除图片 AI 分析模块
2. 重写 AI 文档生成 Prompt
3. 合并繁简转换到 AI 处理阶段

### Phase 2: 优化关键帧处理
1. 简化关键帧提取逻辑
2. 根据章节时间戳自动配图
3. 移除图片筛选模块

### Phase 3: 输出格式优化
1. 新的 Markdown 模板
2. 可选折叠原始转录
3. 添加视频摘要文件

## 技术实现要点

### API 调用优化

```python
# V2: 单次 API 调用完成所有处理
def generate_document(segments: list[TranscriptSegment], title: str) -> str:
    """使用 Kimi API 一步完成去重、格式化、翻译。"""
    
    # 构建输入
    transcript_json = {
        "title": title,
        "duration": segments[-1].end if segments else 0,
        "segments": [
            {"start": s.start, "end": s.end, "text": s.text}
            for s in segments
        ]
    }
    
    # 单次 API 调用
    response = client.chat.completions.create(
        model="kimi-k2.5",
        messages=[
            {"role": "system", "content": DOCUMENT_GENERATION_PROMPT},
            {"role": "user", "content": json.dumps(transcript_json, ensure_ascii=False)}
        ]
    )
    
    return response.choices[0].message.content
```

### 关键帧配图策略

```python
def match_frames_to_chapters(frames: list[Keyframe], chapters: list[Chapter]) -> dict:
    """根据时间戳将关键帧匹配到章节。"""
    
    chapter_frames = {}
    for chapter in chapters:
        # 找到该时间范围内的关键帧
        matched = [
            f for f in frames
            if chapter.start_time <= f.timestamp <= chapter.end_time
        ]
        # 每个章节最多配 2 张图
        chapter_frames[chapter.id] = matched[:2]
    
    return chapter_frames
```

---

**确认以上设计后，我将开始分阶段实现。**
