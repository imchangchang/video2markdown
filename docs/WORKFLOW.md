# Video2Markdown 处理流程详解

## 整体架构流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Video2Markdown 处理流程                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   输入视频                                                                   │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 1: 视频分析                                                   │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │ • 读取视频元数据 (FFmpeg)                                           │  │
│   │   - 时长、分辨率、帧率、编码格式                                     │  │
│   │ • 评估处理参数                                                      │  │
│   │   - 关键帧采样间隔                                                  │  │
│   │   - 预估处理时间                                                    │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 2: 音频提取与转录 (ASR)                                       │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐   │  │
│   │   │  提取音频   │───▶│  Whisper    │───▶│   繁简转换          │   │  │
│   │   │  (WAV)     │    │   转录      │    │   (OpenCC)          │   │  │
│   │   │             │    │             │    │                     │   │  │
│   │   │ • FFmpeg   │    │ • 本地模型  │    │ • 繁体中文          │   │  │
│   │   │ • 16kHz    │    │ • 时间戳    │    │ • 转简体中文        │   │  │
│   │   │ • 单声道   │    │ • 分段文本  │    │ • 保持一致性        │   │  │
│   │   └─────────────┘    └─────────────┘    └─────────────────────┘   │  │
│   │                                                                     │  │
│   │ 输出: TranscriptSegment[]                                          │  │
│   │   - start_time: float (秒)                                         │  │
│   │   - end_time: float (秒)                                           │  │
│   │   - text: str (简体中文)                                            │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 3: 关键帧提取                                                  │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐   │  │
│   │  │   场景检测      │    │   均匀采样      │    │   合并筛选   │   │  │
│   │  │   (OpenCV)     │    │   (按间隔)      │    │   去重排序   │   │  │
│   │  │                 │    │                 │    │              │   │  │
│   │  │ • 帧差分析     │    │ • 固定间隔     │    │ • 时间排序   │   │  │
│   │  │ • 检测转场     │    │ • 兜底策略     │    │ • 质量筛选   │   │  │
│   │  │ • 标记场景     │    │ • 确保覆盖     │    │ • 限制数量   │   │  │
│   │  └─────────────────┘    └─────────────────┘    └──────────────┘   │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 4: 智能图片筛选                                                │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   多层筛选策略 (减少 50-70% API 调用):                              │  │
│   │                                                                     │  │
│   │   ┌─────────────┐   ┌─────────────┐   ┌─────────────────────────┐  │  │
│   │   │  第一层     │   │  第二层     │   │  第三层                 │  │  │
│   │   │  颜色分析   │   │  文字检测   │   │  转录上下文             │  │  │
│   │   │             │   │             │   │                         │  │  │
│   │   │ • 检测白色  │   │ • 边缘检测  │   │ • 检查对应时段          │  │  │
│   │   │   背景      │   │ • 文字密度  │   │   转录内容              │  │  │
│   │   │ • PPT/白板  │   │ • 低于阈值  │   │ • 是否提及视觉内容      │  │  │
│   │   │   判定      │   │   跳过      │   │                         │  │  │
│   │   │             │   │             │   │                         │  │  │
│   │   │ 跳过率: 30% │   │ 跳过率: 20% │   │ 跳过率: 20%             │  │  │
│   │   └─────────────┘   └─────────────┘   └─────────────────────────┘  │  │
│   │                                                                     │  │
│   │   判定结果:                                                         │  │
│   │   • ✅ 分析: 检测到PPT/板书类图片，值得分析                         │  │
│   │   • ⏭️  跳过: 图片无显著文字内容，可能是过渡画面                   │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 5: AI 图像分析 (Kimi Vision)                                   │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   输入: 筛选后的关键帧 (通常 5-15 张)                                │  │
│   │                                                                     │  │
│   │   处理流程:                                                         │  │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐   │  │
│   │   │  图片编码   │───▶│  Kimi API   │───▶│   内容描述          │   │  │
│   │   │  (Base64)  │    │   调用      │    │                     │   │  │
│   │   │             │    │             │    │ • 画面内容          │   │  │
│   │   │ • JPG格式  │    │ • 压缩优化  │    │ • 文字提取          │   │  │
│   │   │ • 质量85%  │    │ • 中文提示  │    │ • 与上下文关联      │   │  │
│   │   │ • 尺寸限制 │    │ • 重试机制  │    │                     │   │  │
│   │   └─────────────┘    └─────────────┘    └─────────────────────┘   │  │
│   │                                                                     │  │
│   │   耗时: 约 10-15 秒/张                                              │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 6: AI 文档生成 (Kimi)                                          │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   输入: 转录文本 + 图片分析结果                                      │  │
│   │                                                                     │  │
│   │   处理步骤:                                                         │  │
│   │                                                                     │  │
│   │   1. 内容理解                                                       │  │
│   │      • 分析转录文本主题                                              │  │
│   │      • 识别内容结构和逻辑                                            │  │
│   │                                                                     │  │
│   │   2. 章节划分                                                       │  │
│   │      • 自动识别主题转换点                                            │  │
│   │      • 生成 3-6 个章节                                               │  │
│   │      • 确定每章时间范围                                              │  │
│   │                                                                     │  │
│   │   3. 摘要生成                                                       │  │
│   │      • 每章生成中文摘要                                              │  │
│   │      • 提取核心观点和关键信息                                        │  │
│   │                                                                     │  │
│   │   4. 图片关联                                                       │  │
│   │      • 将图片匹配到对应章节                                          │  │
│   │      • 根据内容选择最相关的图片                                      │  │
│   │                                                                     │  │
│   │   耗时: 约 20-40 秒                                                 │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 7: Markdown 渲染                                               │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   输出结构:                                                         │  │
│   │   ┌─────────────────────────────────────────────────────────────┐  │  │
│   │   │ # 视频标题                                                   │  │  │
│   │   │                                                             │  │  │
│   │   │ ## 目录                                                     │  │  │
│   │   │ 1. [章节1](#section-1)                                     │  │  │
│   │   │ 2. [章节2](#section-2)                                     │  │  │
│   │   │ ...                                                        │  │  │
│   │   │                                                             │  │  │
│   │   │ ## 1. 章节标题                                              │  │  │
│   │   │ **时间:** [00:00:00 - 00:05:00]                            │  │  │
│   │   │                                                             │  │  │
│   │   │ AI生成的内容摘要...                                        │  │  │
│   │   │                                                             │  │  │
│   │   │ **相关画面:**                                              │  │  │
│   │   │ ![时间戳](frames/frame_xxx.jpg)                            │  │  │
│   │   │ *AI图片描述*                                               │  │  │
│   │   │                                                             │  │  │
│   │   │ <details>                                                  │  │  │
│   │   │ <summary>原始转录文字</summary>                            │  │  │
│   │   │                                                            │  │  │
│   │   │ > 转录内容...                                              │  │  │
│   │   │ </details>                                                 │  │  │
│   │   └─────────────────────────────────────────────────────────────┘  │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   输出文件                                                                   │
│   ┌─────────────────────────────────────────────────────────────────┐     │
│   │  • {title}.md          - 主文档                                  │     │
│   │  • {title}_summary.md  - 视频摘要                               │     │
│   │  • {title}.srt         - 字幕文件                               │     │
│   │  • {title}_frames/     - 关键帧图片目录                         │     │
│   └─────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 详细处理时间分析

### 典型视频处理时间 (5-8 分钟)

| 阶段 | 耗时 | 占比 | 说明 |
|-----|------|-----|------|
| 视频分析 | < 1s | < 1% | FFmpeg 读取元数据 |
| 音频提取 | 2-3s | 2% | FFmpeg 提取 WAV |
| **语音转录** | **60-90s** | **35%** | Whisper 本地处理 |
| 关键帧提取 | 2-3s | 2% | OpenCV 处理 |
| **智能筛选** | **1-2s** | **< 1%** | 本地 OpenCV，无 API 调用 |
| **图片分析** | **80-120s** | **45%** | Kimi Vision API，10-15s/张 |
| **文档生成** | **30-40s** | **15%** | Kimi API |
| Markdown 渲染 | < 1s | < 1% | 本地处理 |
| **总计** | **~4-6 分钟** | **100%** | |

### 长视频处理时间 (20-30 分钟)

| 阶段 | 预估耗时 | 说明 |
|-----|---------|------|
| 语音转录 | 4-6 分钟 | 与时长成正比 |
| 图片分析 | 3-5 分钟 | 帧数增加 |
| 文档生成 | 40-60s | 文本量增加 |
| **总计** | **~15-20 分钟** | |

## 性能优化建议

### 1. 减少 API 调用时间

```bash
# 增大关键帧间隔，减少图片数量
video2md process video.mp4 --keyframe-interval 60  # 默认 30
```

### 2. 使用更快的 Whisper 模型

```bash
# .env 配置
KIMI_WHISPER_LOCAL_MODEL=whisper.cpp/models/ggml-base-q8_0.bin  # 更快但准确度略低
```

### 3. 批量处理优化

```bash
# 使用批量脚本，自动跳过已处理视频
./run_batch.sh
```

## 错误处理流程

```
处理过程中错误:
│
├─▶ 视频读取失败
│   └─▶ 提示: "无法读取视频文件，请检查格式"
│
├─▶ 音频提取失败
│   └─▶ 提示: "音频提取失败，尝试备用方法"
│
├─▶ ASR 转录失败
│   └─▶ 回退到占位符: "[音频转录失败...]"
│
├─▶ 单张图片分析失败
│   └─▶ 跳过该图片，继续处理其他
│
└─▶ AI 文档生成失败
    └─▶ 使用基础模板生成文档
```

## 数据流转换

```
视频文件
    │
    ▼ FFmpeg
音频 WAV
    │
    ▼ Whisper
转录文本 (繁体)
    │
    ▼ OpenCC
转录文本 (简体) ─────────┐
    │                     │
    ▼                     │
TranscriptSegment[]       │
    │                     │
    ├──▶ 文档生成 ◀───────┤
    │       │             │
    │       ▼             │
    │   章节划分          │
    │   摘要生成          │
    │       │             │
    │       ▼             │
    └──▶ Markdown  ◀──────┘
            │
            ▼
关键帧图片 ────▶ 智能筛选 ────▶ AI 分析
```

## 文件输出规范

```
testbench/output/
├── {filename}.md              # 主 Markdown 文档
├── {filename}_summary.md      # 视频摘要 (要点列表)
├── {filename}.srt             # SRT 字幕文件
└── {filename}_frames/         # 关键帧目录
    ├── frame_0001_15.557.jpg
    ├── frame_0002_25.108.jpg
    └── ...
```

## 配置参数影响

| 参数 | 影响 | 默认值 | 建议 |
|-----|------|-------|------|
| `--keyframe-interval` | 图片数量 | 30s | 短视频 20s，长视频 60s |
| `--language` | 转录语言 | zh | 根据视频语音设置 |
| `KIMI_WHISPER_LOCAL_MODEL` | 转录速度/准确度 | small | tiny(快) / medium(准) |
| `KIMI_MODEL` | 文档生成质量 | kimi-k2.5 | 通常无需修改 |

---

*最后更新: 2024-02-10*
