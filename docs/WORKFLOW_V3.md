# Video2Markdown V3 处理流程（精细化设计）

> 📁 **Prompt 管理**: 所有 AI Prompt 单独存放在 `prompts/` 目录下，便于人工微调：
> - `prompts/document_generation.md` - 文档生成主 Prompt
> - `prompts/image_analysis.md` - 图片分析 Prompt
> - `prompts/text_cleaning.md` - 文本清洗参考 Prompt

## 核心流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         V3 精细化处理流程                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   输入视频 (中/英文)                                                         │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 1: 视频分析                                                   │  │
│   │ • 读取元数据 (时长、分辨率等)                                       │  │
│   │ • 检测场景变化点（用于后续精准配图）                                │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 2: 音频提取与转录                                             │  │
│   │                                                                     │  │
│   │   音频 ──▶ Whisper ──▶ 转录文本 (原语言，保留时间戳)                │  │
│   │                                                                     │  │
│   │   输出: Segment[] {start, end, text(中/英文)}                       │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 3: AI 文档生成 (核心步骤)                                     │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   输入: 转录文本 (原语言) + 场景变化时间点                          │  │
│   │                                                                     │  │
│   │   AI 处理 (单次调用):                                               │  │
│   │   ┌─────────────────────────────────────────────────────────────┐  │  │
│   │   │  ① 内容理解与结构化                                          │  │  │
│   │   │     • 划分主题章节 (3-6个)                                   │  │  │
│   │   │     • 识别每个章节的核心内容                                 │  │  │
│   │   │     • 标记需要配图的关键概念/数据/图表位置                   │  │  │
│   │   │                                                              │  │  │
│   │   │  ② 语言处理                                                  │  │  │
│   │   │     • 中文(繁/简) → 简体中文                                 │  │  │
│   │   │     • **英文 → 翻译为简体中文**               │  │  │
│   │   │                                                              │  │  │
│   │   │  ③ 文本优化                                                  │  │  │
│   │   │     • 去除语气词（嗯、啊、那个、you know等）                 │  │  │
│   │   │     • 合并重复表述                                           │  │  │
│   │   │     • 格式化分段                                             │  │  │
│   │   │                                                              │  │  │
│   │   │  ④ 输出结构化数据                                            │  │  │
│   │   └─────────────────────────────────────────────────────────────┘  │  │
│   │                                                                     │  │
│   │   输出格式 (JSON):                                                  │  │
│   │   {                                                                 │  │
│   │     "title": "主题标题",                                            │  │
│   │     "chapters": [                                                   │  │
│   │       {                                                             │  │
│   │         "id": 1,                                                    │  │
│   │         "title": "章节标题",                                        │  │
│   │         "time_range": ["00:00:00", "00:05:30"],                     │  │
│   │         "summary": "AI生成的摘要（简体中文）",                      │  │
│   │         "key_points": ["要点1", "要点2"],                           │  │
│   │         "cleaned_transcript": "清洗后的原文（折叠）",               │  │
│   │         "needs_visual": true/false,    // 是否需要配图            │  │
│   │         "visual_timestamp": 125.5       // 配图推荐时间点         │  │
│   │       }                                                             │  │
│   │     ]                                                               │  │
│   │   }                                                                 │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 4: 智能配图与分析                                             │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   条件触发: 仅当 chapter.needs_visual == true                      │  │
│   │                                                                     │  │
│   │   流程:                                                             │  │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐   │  │
│   │   │  精准提取   │───▶│  AI 图像    │───▶│   内容提取与        │   │  │
│   │   │  关键帧     │    │   分析      │    │   格式转换          │   │  │
│   │   │             │    │             │    │                     │   │  │
│   │   │ • 根据      │    │ • 识别      │    │ • 提取图中文字      │   │  │
│   │   │   推荐时间  │    │   画面内容  │    │ • 描述关键信息      │   │  │
│   │   │ • 提取单帧  │    │ • 识别图表  │    │ • 转为简体中文      │   │  │
│   │   │ • 质量检查  │    │ • 识别PPT   │    │ • 生成简洁描述      │   │  │
│   │   └─────────────┘    └─────────────┘    └─────────────────────┘   │  │
│   │                                                                     │  │
│   │   输出: 图片分析结果 (折叠在图片下方)                               │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ Stage 5: Markdown 组装与输出                                        │  │
│   │ ────────────────────────────────────────────────────────────────── │  │
│   │                                                                     │  │
│   │   文档结构:                                                         │  │
│   │   ┌─────────────────────────────────────────────────────────────┐  │  │
│   │   │ # 视频标题                                                   │  │  │
│   │   │                                                             │  │  │
│   │   │ ## 目录                                                     │  │  │
│   │   │ 1. [章节1](#section-1)                                     │  │  │
│   │   │ ...                                                        │  │  │
│   │   │                                                             │  │  │
│   │   │ ---                                                        │  │  │
│   │   │ ## 1. 章节标题                                             │  │  │
│   │   │ **时间:** [00:00:00 - 00:05:30]                            │  │  │
│   │   │                                                             │  │  │
│   │   │ ### 内容摘要                                               │  │  │
│   │   │ {AI生成的摘要}                                             │  │  │
│   │   │                                                             │  │  │
│   │   │ ### 关键要点                                               │  │  │
│   │   │ - 要点1                                                    │  │  │
│   │   │ - 要点2                                                    │  │  │
│   │   │                                                             │  │  │
│   │   │ ### 相关画面                                               │  │  │
│   │   │ ![时间戳](frames/frame_xxx.jpg)                            │  │  │
│   │   │ <details>                                                 │  │  │
│   │   │ <summary>🖼️ 画面内容</summary>                            │  │  │
│   │   │ {AI分析后的图片描述（简体中文）}                         │  │  │
│   │   │ </details>                                                │  │  │
│   │   │                                                             │  │  │
│   │   │ ### 原文记录                                               │  │  │
│   │   │ <details>                                                 │  │  │
│   │   │ <summary>📄 查看原始转录</summary>                        │  │  │
│   │   │                                                             │  │  │
│   │   │ {清洗后的转录文字（去语气词、格式化）}                   │  │  │
│   │   │ </details>                                                │  │  │
│   │   │                                                             │  │  │
│   │   │ ---                                                        │  │  │
│   │   │ ...                                                        │  │  │
│   │   └─────────────────────────────────────────────────────────────┘  │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│      │                                                                      │
│      ▼                                                                      │
│   输出文件                                                                   │
│   ┌─────────────────────────────────────────────────────────────────┐     │
│   │  • {title}.md          - 主文档                                 │     │
│   │  • {title}.srt         - 字幕文件 (原语言，供参考)             │     │
│   │  • {title}_frames/     - 关键帧图片 (按需提取)                 │     │
│   └─────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 关键设计细节

### Stage 3: AI 文档生成 Prompt

```python
DOCUMENT_GENERATION_PROMPT = '''
你是一个专业的视频内容编辑助手。请分析视频转录文本，生成结构化文档并智能判断配图需求。

## 输入格式
{
  "title": "视频文件名",
  "language": "zh/en/mixed",  // 检测到的主要语言
  "duration": 600,
  "segments": [
    {"start": 0.0, "end": 5.2, "text": "转录文本"}
  ],
  "scene_changes": [15.5, 45.2, 120.8]  // 场景变化时间点
}

## 处理要求

### 1. 章节划分 (3-6个)
根据内容逻辑划分章节，每个章节包含：
- 标题：概括核心内容（10-20字）
- 时间范围：起止时间戳
- 摘要：200-400字总结（**简体中文**）
- 要点：3-5个 bullet points（**简体中文**）

### 2. 语言处理
- 繁体中文 → **转换为简体中文**
- 简体中文 → 保持不变
- **英文** → **翻译为简体中文**
- 混合内容 → 全部统一为 **简体中文**，英文术语可保留括号标注

### 3. 文本清洗（原始转录）
对每个章节的原始文本进行：
- 去除语气词：嗯、啊、那个、这个、you know、like 等
- 去除重复表述（口语中的重复强调）
- 修正明显的语音识别错误
- 按句子/段落合理分行

### 4. 智能配图判断
对每个章节分析是否需要配图：
- **需要配图的情况**：
  * 提及数据、图表、代码示例
  * 讲解界面操作、软件功能
  * 展示硬件、设备、实物
  * PPT/板书内容重要
  * 概念需要视觉辅助理解
  
- **不需要配图的情况**：
  * 纯观点阐述、闲聊
  * 过渡性内容
  * 纯人物出镜无展示

如果判断需要配图，从 scene_changes 中选择最接近该章节中间位置的 1 个时间点。

## 输出格式 (JSON)
{
  "title": "文档标题（简体中文）",
  "chapters": [
    {
      "id": 1,
      "title": "章节标题（简体中文）",
      "start_time": "00:00:00",
      "end_time": "00:05:30",
      "summary": "AI生成的摘要（简体中文）",
      "key_points": ["要点1", "要点2", "要点3"],
      "cleaned_transcript": "清洗后的原文（去除语气词、格式化）",
      "needs_visual": true,
      "visual_timestamp": 125.5,
      "visual_reason": "展示代码示例"
    }
  ]
}

只输出 JSON，不要有其他内容。
'''
```

### Stage 4: 图片分析 Prompt

```python
IMAGE_ANALYSIS_PROMPT = '''
分析这张视频截图，提取关键信息并用中文描述。

## 分析要求
1. 识别画面主要内容（PPT/代码/界面/硬件/人物等）
2. 提取画面中的文字（如果有）
3. 解释该画面与上下文的关系

## 输出格式（简洁）
• 类型：[PPT/代码/界面/图表/其他]
• 内容：[关键文字或描述]
• 说明：[与讲解内容的关系，1-2句话]

请用**简体中文**输出。
'''
```

## 成本与性能预估

### API 调用次数

| 视频类型 | Stage 3 (文档) | Stage 4 (图片) | 总次数 |
|---------|---------------|---------------|-------|
| 讲解类 (5-8分钟) | 1 次 | 2-4 次 | **3-5 次** |
| 教程类 (10-15分钟) | 1 次 | 4-6 次 | **5-7 次** |
| 长视频 (20-30分钟) | 1 次 | 6-8 次 | **7-9 次** |

### 成本对比

| 方案 | 单视频成本 | 成本降低 |
|-----|-----------|---------|
| V1 (全量图片分析) | ¥0.15-0.25 | - |
| **V3 (智能配图)** | **¥0.02-0.05** | **70-80%** |

### 处理时间

| 阶段 | 预估时间 |
|-----|---------|
| 视频分析 | < 1s |
| 音频转录 | 2-3 分钟 |
| AI 文档生成 | 10-20s |
| 智能配图 (按需) | 10-15s × N 张 |
| Markdown 组装 | < 1s |
| **总计 (5分钟视频)** | **3-4 分钟** |

## 实现优先级

### Phase 1: 核心流程 (MVP)
1. 重写 AI 文档生成模块（单次调用，输出 JSON）
2. 实现文本清洗和语言转换
3. 新的 Markdown 渲染器

### Phase 2: 智能配图
1. 集成场景变化检测（Stage 1）
2. 实现精准关键帧提取
3. 条件触发图片分析

### Phase 3: 优化
1. 中英文混合处理优化
2. 缓存机制（避免重复处理）
3. 配置项（是否双语输出等）

---

**请确认以上设计后，我开始 Phase 1 实现。**
