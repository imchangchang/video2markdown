# Video2Markdown 7-Stage æµ‹è¯•æ¸…å•

> æµ‹è¯•ç›®æ ‡ï¼šéªŒè¯å„ Stage ç‹¬ç«‹è¿è¡ŒåŠ Pipeline ç«¯åˆ°ç«¯æµç¨‹

---

## ç¯å¢ƒå‡†å¤‡

### å‰ç½®æ£€æŸ¥
```bash
# 1. ç¡®è®¤æµ‹è¯•è§†é¢‘å­˜åœ¨
ls -la testdata/videos/

# 2. ç¡®è®¤ Whisper æ¨¡å‹å­˜åœ¨
ls -la models/ggml-medium-q8_0.bin

# 3. ç¡®è®¤ API Key é…ç½®
cat .env | grep KIMI_API_KEY

# 4. æ¸…ç†å†å²è¾“å‡ºï¼ˆå¦‚éœ€å…¨æ–°æµ‹è¯•ï¼‰
rm -rf test_outputs/results/* test_outputs/temp/*
```

### æµ‹è¯•è§†é¢‘æ¨è
| è§†é¢‘ | æ—¶é•¿ | ç”¨é€” |
|------|------|------|
| `åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4` | ~3åˆ†é’Ÿ | **æ¨èç”¨äºæµ‹è¯•**ï¼ˆçŸ­å°ï¼Œå¿«é€ŸéªŒè¯ï¼‰ |
| `[177]--45ã€CANç³»ç»Ÿè°ƒè¯•æ–¹æ³•ç»éªŒæ€»ç»“.mp4` | ~2åˆ†é’Ÿ | çŸ­æµ‹è¯• |
| `[201]--68ã€USBçš„è°ƒè¯•è¿‡ç¨‹ä»¥åŠè°ƒè¯•æ–¹æ³•.mp4` | ~1åˆ†é’Ÿ | æœ€çŸ­æµ‹è¯• |
| `ã€é—ªå®¢ã€‘åè¯è¯ˆéª—ï¼ä¸€å£æ°”æ‹†ç©¿Skill_MCP_RAG_Agent_OpenClawåº•å±‚é€»è¾‘.mp4` | ~9åˆ†é’Ÿ | é•¿è§†é¢‘æµ‹è¯• |

---

## Stage 1: è§†é¢‘åˆ†æ

### å‘½ä»¤
```bash
uv run python -m video2markdown stage1 \
  "testdata/videos/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4"
```

### é¢„æœŸè¾“å‡º
```
åˆ†æè§†é¢‘: åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4
  æ—¶é•¿: 0:03:25
  åˆ†è¾¨ç‡: 1920x1080
  å¸§ç‡: 30.0
  æ£€æµ‹åˆ° 12 ä¸ªåœºæ™¯åˆ‡æ¢ç‚¹

ç»“æœå·²ä¿å­˜: test_outputs/results/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚_stage1.json
```

### éªŒè¯æ£€æŸ¥ç‚¹
- [ ] JSON æ–‡ä»¶ç”Ÿæˆ
- [ ] duration > 0
- [ ] resolution æ ¼å¼æ­£ç¡® (å¦‚ 1920x1080)
- [ ] fps > 0
- [ ] scene_changes ä¸ºæ•°ç»„ä¸”é•¿åº¦ >= 0

---

## Stage 2: éŸ³é¢‘æå–ä¸è½¬å½• (M1)

### å‘½ä»¤
```bash
# é¦–æ¬¡è¿è¡Œï¼ˆæ— ç¼“å­˜ï¼Œä¼šæ‰§è¡Œ Whisper è½¬å½•ï¼‰
uv run python -m video2markdown stage2 \
  "testdata/videos/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4"

# äºŒæ¬¡è¿è¡Œï¼ˆæœ‰ç¼“å­˜ï¼Œè·³è¿‡ Whisperï¼Œç›´æ¥ AI ä¼˜åŒ–ï¼‰
uv run python -m video2markdown stage2 \
  "testdata/videos/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4"

# å¼ºåˆ¶æ¸…é™¤ç¼“å­˜é‡æ–°è½¬å½•
uv run python -m video2markdown stage2 \
  "testdata/videos/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4" --clear-cache
```

### é¢„æœŸè¾“å‡ºï¼ˆé¦–æ¬¡ï¼‰
```
ä½¿ç”¨ Whisper æ¨¡å‹: ggml-medium-q8_0.bin
æå–éŸ³é¢‘: test_outputs/temp/audio_xxxx.wav

[whisper è½¬å½•è¾“å‡º...]

è½¬å½•å®Œæˆ: 125 ä¸ªç‰‡æ®µ
AI ä¼˜åŒ–ä¸­...

M1 å·²ç”Ÿæˆ:
  SRT: test_outputs/results/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.srt
  æ–‡å­—ç¨¿: test_outputs/results/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚_word.md
```

### éªŒè¯æ£€æŸ¥ç‚¹
- [ ] SRT æ–‡ä»¶ç”Ÿæˆï¼ˆæ—¶é—´æˆ³ + æ–‡æœ¬ï¼‰
- [ ] `_word.md` æ–‡ä»¶ç”Ÿæˆï¼ˆAI ä¼˜åŒ–åçš„æ–‡ç« æ ¼å¼ï¼‰
- [ ] word.md å†…å®¹æ£€æŸ¥ï¼š
  - [ ] æœ‰æ ‡é¢˜ï¼ˆ# å¼€å¤´ï¼‰
  - [ ] æœ‰å°æ ‡é¢˜ï¼ˆ## å¼€å¤´ï¼‰
  - [ ] æœ‰ [MM:SS] æ—¶é—´æˆ³
  - [ ] å†…å®¹é€šé¡ºå¯è¯»ï¼ˆä¸æ˜¯åŸå§‹è½¬å½•ï¼‰
- [ ] ç¼“å­˜æ–‡ä»¶ç”Ÿæˆï¼š`test_outputs/temp/cache/stage2/{hash}_raw.json`
- [ ] äºŒæ¬¡è¿è¡Œæ—¶é€Ÿåº¦æ›´å¿«ï¼ˆè·³è¿‡ Whisperï¼‰

---

## Stage 3: å…³é”®å¸§æå–

### å‘½ä»¤
```bash
uv run python -m video2markdown stage3 \
  "testdata/videos/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4"
```

### é¢„æœŸè¾“å‡º
```
æå–å€™é€‰å…³é”®å¸§...
åœºæ™¯åˆ‡æ¢å¸§: 12
å›ºå®šé—´éš”å¸§: 20
è¯­éŸ³å¯¹é½å¸§: 8
å»é‡åå€™é€‰å¸§: 35

å€™é€‰å¸§å·²ä¿å­˜: test_outputs/results/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚_stage3.json
```

### éªŒè¯æ£€æŸ¥ç‚¹
- [ ] JSON æ–‡ä»¶ç”Ÿæˆ
- [ ] keyframes æ•°ç»„éç©º
- [ ] æ¯ä¸ª keyframe åŒ…å«ï¼š
  - [ ] timestamp (ç§’)
  - [ ] source (scene/interval/transcript)
  - [ ] reason (å­—ç¬¦ä¸²è¯´æ˜)
- [ ] æ—¶é—´æˆ³åˆç†ï¼ˆåœ¨è§†é¢‘æ—¶é•¿èŒƒå›´å†…ï¼‰

---

## Stage 4: æ™ºèƒ½å›¾ç‰‡ç­›é€‰ (M2)

### å‘½ä»¤
```bash
uv run python -m video2markdown stage4 \
  "testdata/videos/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4"
```

### é¢„æœŸè¾“å‡º
```
ä½¿ç”¨ Whisper æ¨¡å‹: ggml-medium-q8_0.bin
æå–éŸ³é¢‘: test_outputs/temp/audio_xxxx.wav
è½¬å½•å®Œæˆ: 125 ä¸ªç‰‡æ®µ
AI ä¼˜åŒ–å®Œæˆ: 22 ä¸ªæ®µè½
æå–å€™é€‰å…³é”®å¸§...
åœºæ™¯åˆ‡æ¢å¸§: 12
å›ºå®šé—´éš”å¸§: 20
è¯­éŸ³å¯¹é½å¸§: 8
å»é‡åå€™é€‰å¸§: 35

ç­›é€‰å…³é”®å¸§...
åŸºäº OCR æ–‡æœ¬åŒ¹é…: ä¿ç•™ 15 å¸§
åŸºäºè¯­ä¹‰ç›¸å…³æ€§: ä¿ç•™ 12 å¸§
åŸºäºè§†è§‰è´¨é‡: ä¿ç•™ 10 å¸§
æœ€ç»ˆç­›é€‰ç»“æœ: 10 å¸§

M2 (ç­›é€‰åçš„å…³é”®å¸§) å·²ä¿å­˜: test_outputs/results/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚_stage4.json
```

### éªŒè¯æ£€æŸ¥ç‚¹
- [ ] JSON æ–‡ä»¶ç”Ÿæˆ
- [ ] filtered_frames æ•°é‡ < Stage 3 çš„å€™é€‰å¸§æ•°é‡
- [ ] æ¯å¸§åŒ…å«ç­›é€‰åŸå› 

---

## Stage 5: AI å›¾åƒåˆ†æ (M3)

### å‘½ä»¤
```bash
uv run python -m video2markdown stage5 \
  "testdata/videos/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4"
```

### é¢„æœŸè¾“å‡º
```
ä½¿ç”¨ Whisper æ¨¡å‹: ggml-medium-q8_0.bin
[Stage 2-4 æ‰§è¡Œä¸­...]

åˆ†æå…³é”®å¸§...
[45.2s] å›¾ä¸­å±•ç¤ºäº†ä¸²å£é€šä¿¡çš„ä¸‰å±‚æ¶æ„å›¾ï¼ŒåŒ…æ‹¬ç‰©ç†å±‚ã€æ•°æ®é“¾è·¯å±‚å’Œåº”ç”¨å±‚...
[78.5s] ä»£ç ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨ç‰©ç†å±‚å®ç°ä¸²å£åˆå§‹åŒ–...
...

M3 (å›¾ç‰‡åˆ†æ) å·²å®Œæˆ
  é…å›¾ä¿å­˜: test_outputs/results/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚_frames
    [45.2s] å›¾ä¸­å±•ç¤ºäº†ä¸²å£é€šä¿¡çš„ä¸‰å±‚æ¶æ„å›¾...
    [78.5s] ä»£ç ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨ç‰©ç†å±‚...
    ...
```

### éªŒè¯æ£€æŸ¥ç‚¹
- [ ] `_frames` ç›®å½•åˆ›å»º
- [ ] ç›®å½•ä¸­åŒ…å«ç­›é€‰åçš„å…³é”®å¸§å›¾ç‰‡ï¼ˆ.jpg/.pngï¼‰
- [ ] å›¾ç‰‡å‘½ååŒ…å«æ—¶é—´æˆ³ï¼ˆå¦‚ `frame_04520.jpg`ï¼‰
- [ ] ç»ˆç«¯è¾“å‡ºæ¯å¸§çš„æè¿°æ–‡å­—

---

## Stage 6: AI æ–‡æ¡£ç”Ÿæˆ

### å‘½ä»¤
```bash
uv run python -m video2markdown stage6 \
  "testdata/videos/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4"
```

### é¢„æœŸè¾“å‡º
```
ä½¿ç”¨ Whisper æ¨¡å‹: ggml-medium-q8_0.bin
[Stage 2-5 æ‰§è¡Œä¸­...]

ç”Ÿæˆæ–‡æ¡£ç»“æ„...
  æ ‡é¢˜: åµŒå…¥å¼è¿›é˜¶ï¼šä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚
  - ä¸ºä»€ä¹ˆéœ€è¦åˆ†å±‚è®¾è®¡
  - ä¸‰å±‚æ¶æ„è¯¦è§£
  - ç‰©ç†å±‚å®ç°
  - æ•°æ®é“¾è·¯å±‚è®¾è®¡
  - åº”ç”¨å±‚æ¥å£
  - æ€»ç»“ä¸æœ€ä½³å®è·µ

æ–‡æ¡£ç»“æ„å·²ç”Ÿæˆ:
  æ ‡é¢˜: åµŒå…¥å¼è¿›é˜¶ï¼šä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚
  - ä¸ºä»€ä¹ˆéœ€è¦åˆ†å±‚è®¾è®¡
  - ä¸‰å±‚æ¶æ„è¯¦è§£
  - ...
```

### éªŒè¯æ£€æŸ¥ç‚¹
- [ ] ç»ˆç«¯è¾“å‡ºæ–‡æ¡£æ ‡é¢˜å’Œç« èŠ‚åˆ—è¡¨
- [ ] ç« èŠ‚ç»“æ„åˆç†ï¼ˆç¬¦åˆè§†é¢‘å†…å®¹ï¼‰
- [ ] ç« èŠ‚æ•° >= 3

---

## Stage 7: Markdown æ¸²æŸ“

### å‘½ä»¤
```bash
# é€šè¿‡å®Œæ•´æµç¨‹å‘½ä»¤æ‰§è¡Œ Stage 7
uv run python -m video2markdown process \
  "testdata/videos/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4" \
  -o test_outputs/results/full_test
```

### é¢„æœŸè¾“å‡º
```
å¤„ç†è§†é¢‘: åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4
è¾“å‡ºç›®å½•: test_outputs/results/full_test

ä½¿ç”¨ Whisper æ¨¡å‹: ggml-medium-q8_0.bin

==================================================
[Stage 1-6 æ‰§è¡Œä¸­...]

==================================================
æ¸²æŸ“æœ€ç»ˆæ–‡æ¡£...

âœ… å¤„ç†å®Œæˆ!
è¾“å‡º: test_outputs/results/full_test
```

### éªŒè¯æ£€æŸ¥ç‚¹
- [ ] æœ€ç»ˆ Markdown æ–‡ä»¶ç”Ÿæˆï¼š`{title}.md`
- [ ] æ–‡ä»¶å†…å®¹åŒ…å«ï¼š
  - [ ] æ ‡é¢˜ï¼ˆ# ä¸€çº§æ ‡é¢˜ï¼‰
  - [ ] ç« èŠ‚ç»“æ„ï¼ˆ## äºŒçº§æ ‡é¢˜ï¼‰
  - [ ] é…å›¾æ’å…¥ï¼ˆ`![æè¿°](è·¯å¾„)`ï¼‰
  - [ ] é…å›¾ä¸ç›¸å…³æ®µè½é è¿‘
- [ ] `_frames` ç›®å½•ä¸­çš„å›¾ç‰‡è¢«æ­£ç¡®å¼•ç”¨
- [ ] æ–‡æ¡£å¯ç›´æ¥ç”¨ Markdown é˜…è¯»å™¨æ‰“å¼€æŸ¥çœ‹

---

## å®Œæ•´æµç¨‹æµ‹è¯•

### å¿«é€Ÿæµ‹è¯•ï¼ˆçŸ­è§†é¢‘ï¼‰
```bash
# ä½¿ç”¨ 1 åˆ†é’Ÿè§†é¢‘å¿«é€ŸéªŒè¯å…¨æµç¨‹
uv run python -m video2markdown process \
  "testdata/videos/[201]--68ã€USBçš„è°ƒè¯•è¿‡ç¨‹ä»¥åŠè°ƒè¯•æ–¹æ³•.mp4" \
  -o test_outputs/results/full_usb
```

### æ ‡å‡†æµ‹è¯•ï¼ˆ3åˆ†é’Ÿè§†é¢‘ï¼‰
```bash
# ä½¿ç”¨ 3 åˆ†é’Ÿè§†é¢‘æ ‡å‡†éªŒè¯
uv run python -m video2markdown process \
  "testdata/videos/åµŒå…¥å¼è¿›é˜¶ä¹‹ä¸ºä»€ä¹ˆä¸²å£ç¨‹åºè®¾è®¡æ—¶è¦åˆ†ä¸‰å±‚.mp4" \
  -o test_outputs/results/full_uart
```

### éªŒè¯æ£€æŸ¥ç‚¹
- [ ] æ‰€æœ‰ 7 ä¸ª Stage æ— æŠ¥é”™å®Œæˆ
- [ ] è¾“å‡ºç›®å½•åŒ…å«ï¼š
  - [ ] `{title}.md` - æœ€ç»ˆæ–‡æ¡£
  - [ ] `{title}_word.md` - M1 æ–‡å­—ç¨¿
  - [ ] `{title}.srt` - å­—å¹•æ–‡ä»¶
  - [ ] `{title}_frames/` - é…å›¾ç›®å½•
- [ ] æœ€ç»ˆ Markdown å¯æ­£å¸¸æ¸²æŸ“
- [ ] é…å›¾ä¸æ–‡å­—å†…å®¹ç›¸å…³

---

## æµ‹è¯•ç»“æœè®°å½•è¡¨

| Stage | å‘½ä»¤ | çŠ¶æ€ | å¤‡æ³¨ |
|-------|------|------|------|
| Stage 1 | `stage1` | âœ… | è§†é¢‘åˆ†ææ­£å¸¸ |
| Stage 2 | `stage2` | âœ… | ç¼“å­˜åŠŸèƒ½æ­£å¸¸ |
| Stage 3 | `stage3` | âœ… | å…³é”®å¸§æå–æ­£å¸¸ |
| Stage 4 | `stage4` | âœ… | ç­›é€‰ä»7å¸§â†’2å¸§ |
| Stage 5 | `stage5` | âœ… | AIå›¾åƒåˆ†ææ­£å¸¸ |
| Stage 6 | `stage6` | âœ… | ç”Ÿæˆ2ä¸ªç« èŠ‚ |
| Stage 7 | `process` | âœ… | Markdownæ¸²æŸ“å®Œæ•´ |
| å…¨æµç¨‹ | `process` (1åˆ†é’Ÿè§†é¢‘) | âœ… | ç«¯åˆ°ç«¯éªŒè¯é€šè¿‡ |

**çŠ¶æ€å›¾ä¾‹**: â¬œ æœªæµ‹è¯• / ğŸŸ¡ è¿›è¡Œä¸­ / âœ… é€šè¿‡ / âŒ å¤±è´¥

**æµ‹è¯•æ—¥æœŸ**: 2026-02-12
**æµ‹è¯•è§†é¢‘**: `[201]--68ã€USBçš„è°ƒè¯•è¿‡ç¨‹ä»¥åŠè°ƒè¯•æ–¹æ³•.mp4` (180ç§’)

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### Stage 2 - Whisper æ¨¡å‹æ‰¾ä¸åˆ°
```bash
# æ£€æŸ¥æ¨¡å‹è·¯å¾„
uv run python -c "from video2markdown.config import settings; print(settings.resolve_whisper_model())"

# å¦‚æœè¿”å› Noneï¼Œæ£€æŸ¥ .env ä¸­çš„ KIMI_WHISPER_MODEL æˆ–ä½¿ç”¨é»˜è®¤åç§°
```

### Stage 2 - API è°ƒç”¨å¤±è´¥
- æ£€æŸ¥ `.env` ä¸­ `KIMI_API_KEY` æ˜¯å¦è®¾ç½®
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—ä¸­çš„å…·ä½“ API é”™è¯¯ä¿¡æ¯

### Stage 5/6/7 - ä¾èµ–å‰é¢ Stage çš„è¾“å‡º
è¿™äº› Stage éœ€è¦å‰é¢æ‰€æœ‰ Stage å®Œæˆã€‚å¦‚æœåªæƒ³æµ‹è¯•åç»­ Stageï¼Œå…ˆç¡®ä¿å‰é¢ Stage å·²æ‰§è¡Œè¿‡ã€‚

---

*æµ‹è¯•æ¸…å•ç‰ˆæœ¬: 1.0*
*æœ€åæ›´æ–°: 2026-02-12*
